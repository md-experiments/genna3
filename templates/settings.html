<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genna - Project Settings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .column-item {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .column-name {
            margin: 0;
            font-weight: 500;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            padding: 2px;
            font-size: 1rem;
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .action-btn.active.show { color: #0d6efd; }
        .action-btn.active.label { color: #198754; }
        .action-btn.active.content { color: #dc3545; }
        .action-btn.active.filter { color: #ffc107; }
        .columns-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
        }
    .annotator-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .annotator-form-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
    }

    .model-prompt {
        width: 100%;
        min-height: 60px;
        resize: vertical;
    }
    .ai-models-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .model-list {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
        }
    .model-item {
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 4px;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        width: 100%;
        word-wrap: break-word;
    }

    .model-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 8px;
    }
    .model-header-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .model-name-labels {
        font-weight: 500;
        word-break: break-word;
    }

    .model-labels {
        font-size: 0.875rem;
        color: var(--text-muted);
    }
    .annotator-form input[type="text"],
    .annotator-form textarea {
        min-width: 0;
        flex: 1;
    }

    .form-control {
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .model-details pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
    }

    .model-list {
        min-width: 0;  /* Allow column to shrink */
    }
    .role-checkboxes {
            display: flex;
            gap: 16px;
            margin-right: 16px;
        }
        .label-type-select {
            font-size: 0.875rem;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100px;
    }
    .label-config {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    .label-config small {
        min-width: 100px;
    }
    .model-scores {
        display: flex;
        gap: 8px;
        margin-top: 4px;
        flex-wrap: wrap;
    }
    .score-item {
        font-size: 0.875rem;
        padding: 2px 6px;
        border-radius: 4px;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
    }
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .progress-container {
        background: var(--bg-color);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        min-width: 300px;
    }
    .progress-spinner {
        width: 50px;
        height: 50px;
        margin: 20px auto;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">‚Üê Back to Genna</a>
            <div class="d-flex">
                <div class="form-check form-switch ms-2">
                    <input class="form-check-input mode-switch" type="checkbox" id="modeSwitch">
                    <label class="form-check-label" for="modeSwitch">Dark</label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Project Settings: {{ project }}</h2>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Project Objective</h5>
                <textarea id="projectObjective" class="form-control" rows="4" placeholder="Enter project objective..."></textarea>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Column Management</h5>
                <p class="text-muted mb-2">Configure how each column is used in the annotation process.</p>
                <div class="mb-2">
                    <i class="bi bi-eye text-primary me-2"></i> Show
                    <i class="bi bi-tag text-success me-2 ms-3"></i> Label
                    <i class="bi bi-body-text text-danger me-2 ms-3"></i> Content
                    <i class="bi bi-funnel text-secondary me-2 ms-3"></i> Filter
                </div>
                <div id="columnsContainer" class="columns-container">
                    <!-- Columns will be added here dynamically -->
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">AI Models</h5>
                <p class="text-muted">Configure AI models for annotation and judgment.</p>

                <div class="ai-models-container mb-4">
                    <div class="model-list">
                        <h6 class="mb-3">Annotators</h6>
                        <div id="annotatorsList">
                            <!-- Annotators will be added here -->
                        </div>
                    </div>
                    <div class="model-list">
                        <h6 class="mb-3">Judges</h6>
                        <div id="judgesList">
                            <!-- Judges will be added here -->
                        </div>
                    </div>
                </div>

    <div class="card">
    <div class="card-body">
        <h6 class="mb-3">Add New Model</h6>
        <div class="annotator-form mb-3">
            <div class="annotator-form-row">
                <select id="newAnnotatorModel" class="form-control" style="width: auto;">
                    <option value="">Select Model</option>
                    <!-- Models will be loaded here -->
                </select>
                <input type="number" id="newAnnotatorTemp" class="form-control" placeholder="Temperature" min="0" max="1" step="0.1" style="width: 120px;">
            </div>
            <textarea id="newAnnotatorPrompt" class="form-control model-prompt" placeholder="Base prompt template"></textarea>
        </div>
        <div class="role-checkboxes mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="isAnnotator">
                <label class="form-check-label" for="isAnnotator">Annotator</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="isJudge">
                <label class="form-check-label" for="isJudge">Judge</label>
            </div>
        </div>
        <div id="labelConfigs">
            <!-- Label configurations will be added here -->
        </div>
        <button class="btn btn-outline-secondary" type="button" id="addAnnotatorBtn">Add Model</button>
    </div>
</div>
<div class="mt-4 mb-4">
            <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
        </div>
    </div>

    
<!-- Add progress overlay -->
<div class="progress-overlay" id="progressOverlay">
    <div class="progress-container">
        <h5>Annotating...</h5>
        <div class="progress-spinner"></div>
        <p id="progressStatus">Processing...</p>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Previous JavaScript remains unchanged until createModelElement function
    document.addEventListener('DOMContentLoaded', () => {
            const modeSwitch = document.getElementById('modeSwitch');
            const projectObjective = document.getElementById('projectObjective');
            const columnsContainer = document.getElementById('columnsContainer');
            const annotatorsList = document.getElementById('annotatorsList');
            const judgesList = document.getElementById('judgesList');
            const isAnnotator = document.getElementById('isAnnotator');
            const isJudge = document.getElementById('isJudge');
            const addAnnotatorBtn = document.getElementById('addAnnotatorBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const newAnnotatorLabelPrompts = document.getElementById('newAnnotatorLabelPrompts');

            let availableModels = [];
            let lastModelSettings = null;

            // Check for saved mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                modeSwitch.checked = true;
            }

            modeSwitch.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', modeSwitch.checked);
            });

        function createColumnElement(columnName, settings) {
            const div = document.createElement('div');
            div.className = 'column-item';
            div.innerHTML = `
                <div class="column-name">${columnName}</div>
                <div class="action-buttons">
                    <button class="action-btn show ${settings.show ? 'active' : ''}" data-action="show" title="Show">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="action-btn label ${settings.label ? 'active' : ''}" data-action="label" title="Label">
                        <i class="bi bi-tag"></i>
                    </button>
                    <button class="action-btn content ${settings.content ? 'active' : ''}" data-action="content" title="Content">
                        <i class="bi bi-body-text"></i>
                    </button>
                    <button class="action-btn filter ${settings.filter ? 'active' : ''}" data-action="filter" title="Filter">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            `;

            // Add click handlers for action buttons
            div.querySelectorAll('.action-btn').forEach(btn => {
                btn.onclick = function() {
                    this.classList.toggle('active');
                    if (btn.classList.contains('label')) {
                        updateLabelConfigs();
                    }
                };
            });

            return div;
        }

        function updateLabelConfigs() {
            const labelColumns = Array.from(document.querySelectorAll('.action-btn.label.active'))
                .map(btn => btn.closest('.column-item').querySelector('.column-name').textContent);

            const labelConfigs = document.getElementById('labelConfigs');
            labelConfigs.innerHTML = labelColumns.map(column => {
                const savedType = lastModelSettings?.label_types?.[column] || 'text';
                const savedPrompt = lastModelSettings?.label_prompts?.[column] || '';
                
                return `
                    <div class="label-config">
                        <small class="text-muted">${column}:</small>
                        <select class="label-type-select" data-column="${column}">
                            <option value="text" ${savedType === 'text' ? 'selected' : ''}>Text</option>
                            <option value="bool" ${savedType === 'bool' ? 'selected' : ''}>Bool</option>
                            <option value="number" ${savedType === 'number' ? 'selected' : ''}>Number</option>
                        </select>
                        <input type="text" class="form-control" placeholder="Prompt for ${column}" 
                               data-column="${column}" value="${savedPrompt}">
                    </div>
                `;
            }).join('');
        }

function generateAnnotatorId(model) {
    // Create a hash from model details and add random suffix
    const modelString = `${model.model_name}-${model.temperature}-${Object.entries(model.label_types || {}).join('-')} ${Math.random()}`;
    return btoa(modelString).replace(/[^a-zA-Z0-9]/g, '');
}

function createModelElement(model) {
    // Ensure model has an annotator_id
    if (!model.annotator_id) {
        model.annotator_id = generateAnnotatorId(model);
    }
    
    // Get list of labels with their types
    const labels = Object.entries(model.label_types || {})
        .map(([column, type]) => `${column} (${type})`)
        .join(', ');
    
    const div = document.createElement('div');
    div.className = 'model-item';
    div.setAttribute('data-annotator-id', model.annotator_id);
    div.innerHTML = `
        <div class="model-header">
            <div class="model-header-left">
                <div class="model-name-labels">
                    ${model.model_name}
                    ${labels ? `<br><small class="text-muted">(${labels}) temp: ${model.temperature}</small>` : ''}
                </div>
                <div class="model-scores">
                    <!-- Scores will be added here -->
                </div>
            </div>
            <button class="btn btn-sm btn-primary annotate-btn">Annotate</button>
        </div>
        <div class="model-details" style="display: none;">
            <div class="mb-2">
                <small class="text-muted">Base Prompt:</small>
                <pre class="border rounded p-2 bg-light mb-2"><code>${model.prompt}</code></pre>
            </div>
            ${Object.entries(model.label_prompts || {}).map(([column, prompt]) => `
                <div class="mb-2">
                    <small class="text-muted">${column} (${model.label_types[column]}):</small>
                    <pre class="border rounded p-2 bg-light mb-1"><code>${prompt}</code></pre>
                </div>
            `).join('')}
        </div>
    `;

    // Add click handler for model header (excluding the annotate button)
    div.querySelector('.model-header-left').addEventListener('click', () => {
        const details = div.querySelector('.model-details');
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
    });

    // Add click handler for annotate button
    div.querySelector('.annotate-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        startAnnotation(model, div);
    });

    // Load scores for this model
    loadModelScores(model, div);

    return div;
}

function startAnnotation(model, element) {
    const progressOverlay = document.getElementById('progressOverlay');
    const progressStatus = document.getElementById('progressStatus');
    progressOverlay.style.display = 'flex';
    progressStatus.textContent = 'Starting annotation...';

    // Start polling immediately
    pollAnnotationProgress(model, element);

    // Start the annotation process (don't wait for response)
    fetch(`/annotate/{{ project }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(model)
    });
}

function pollAnnotationProgress(model, element) {
    const progressStatus = document.getElementById('progressStatus');
    const progressOverlay = document.getElementById('progressOverlay');
    let pollCount = 0;

    function checkProgress() {
        fetch(`/annotation_status/{{ project }}/${encodeURIComponent(model.annotator_id)}`)
            .then(response => response.json())
            .then(data => {
                pollCount++;
                if (data.status === 'completed') {
                    progressStatus.textContent = 'Annotation completed successfully!';
                    setTimeout(() => {
                        progressOverlay.style.display = 'none';
                        // Reload scores after completion
                        loadModelScores(model, element);
                    }, 1500);
                } else if (data.status === 'error') {
                    progressStatus.textContent = 'Error during annotation';
                    setTimeout(() => {
                        progressOverlay.style.display = 'none';
                    }, 1500);
                } else {
                    // Update progress message
                    progressStatus.textContent = data.message || `Processing... (${pollCount} checks)`;
                    // Continue polling every 500ms
                    setTimeout(checkProgress, 500);
                }
            })
            .catch(error => {
                console.error('Error checking progress:', error);
                progressStatus.textContent = `Error checking progress (attempt ${pollCount})`;
                // Continue polling even on error, but less frequently
                setTimeout(checkProgress, 2000);
            });
    }

    // Start polling immediately
    checkProgress();
}


function loadModelScores(model, element) {
    fetch(`/scores/{{ project }}/${encodeURIComponent(model.annotator_id)}`)
        .then(response => response.json())
        .then(scores => {
            const scoresContainer = element.querySelector('.model-scores');
            scoresContainer.innerHTML = Object.entries(scores)
                .map(([metric, value]) => `
                    <span class="score-item">
                        ${metric}: ${typeof value === 'number' ? value.toFixed(2) : value}
                    </span>
                `).join('');
        })
        .catch(error => {
            console.error('Error loading scores:', error);
        });
}

function validateAnnotatorFields() {
                const model = document.getElementById('newAnnotatorModel').value.trim();
                const temp = parseFloat(document.getElementById('newAnnotatorTemp').value);
                const prompt = document.getElementById('newAnnotatorPrompt').value.trim();
                const hasRole = isAnnotator.checked || isJudge.checked;

                if (!model) {
                    alert('Please select a model');
                    return false;
                }
                if (isNaN(temp) || temp < 0 || temp > 1) {
                    alert('Temperature must be between 0 and 1');
                    return false;
                }
                if (!prompt) {
                    alert('Please enter a base prompt');
                    return false;
                }
                if (!hasRole) {
                    alert('Please select at least one role (Annotator or Judge)');
                    return false;
                }

                // Validate label prompts
                const labelInputs = document.querySelectorAll('#labelConfigs input');
                if (labelInputs.length > 0) {
                    let allPromptsValid = true;
                    labelInputs.forEach(input => {
                        if (!input.value.trim()) {
                            alert(`Please enter a prompt for ${input.dataset.column}`);
                            allPromptsValid = false;
                        }
                    });
                    if (!allPromptsValid) return false;
                }

                return true;
            }

addAnnotatorBtn.onclick = () => {
    if (!validateAnnotatorFields()) return;

    const model = {
        model_name: document.getElementById('newAnnotatorModel').value,
        temperature: parseFloat(document.getElementById('newAnnotatorTemp').value),
        prompt: document.getElementById('newAnnotatorPrompt').value.trim(),
        label_prompts: {},
        label_types: {},
        roles: []
    };

    // Collect label configurations
    document.querySelectorAll('#labelConfigs .label-config').forEach(config => {
        const column = config.querySelector('input').dataset.column;
        model.label_prompts[column] = config.querySelector('input').value.trim();
        model.label_types[column] = config.querySelector('select').value;
    });

    // Add roles
    if (isAnnotator.checked) model.roles.push('annotator');
    if (isJudge.checked) model.roles.push('judge');

    // Generate annotator_id
    model.annotator_id = generateAnnotatorId(model);

    // Save as last model settings
    lastModelSettings = {
        model_name: model.model_name,
        temperature: model.temperature,
        prompt: model.prompt,
        label_prompts: {...model.label_prompts},
        label_types: {...model.label_types},
        annotator_id: model.annotator_id
    };

    // Create model element
    const modelElement = createModelElement(model);

    // Add to appropriate lists
    if (isAnnotator.checked) {
        annotatorsList.appendChild(modelElement.cloneNode(true));
    }
    if (isJudge.checked) {
        judgesList.appendChild(modelElement.cloneNode(true));
    }

    // Save settings to backend
    fetch(`/get_project_settings/{{ project }}`)
        .then(response => response.json())
        .then(data => {
            const settings = data.settings;
            settings.ai_annotators = settings.ai_annotators || [];
            settings.ai_annotators.push(model);

            fetch(`/save_project_settings/{{ project }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Error saving model settings');
                }
            });
        });

    // Clear role checkboxes only
    isAnnotator.checked = false;
    isJudge.checked = false;

    // Prepopulate for next model
    document.getElementById('newAnnotatorModel').value = model.model_name;
    document.getElementById('newAnnotatorTemp').value = model.temperature;
    document.getElementById('newAnnotatorPrompt').value = model.prompt;
};

saveSettingsBtn.onclick = () => {
    const columnSettings = {};
    columnsContainer.querySelectorAll('.column-item').forEach(item => {
        const columnName = item.querySelector('.column-name').textContent;
        columnSettings[columnName] = {
            show: item.querySelector('.show').classList.contains('active'),
            label: item.querySelector('.label').classList.contains('active'),
            content: item.querySelector('.content').classList.contains('active'),
            filter: item.querySelector('.filter').classList.contains('active')
        };
    });

    // Get the current settings from the backend and update only the columns and objective
    fetch(`/get_project_settings/{{ project }}`)
        .then(response => response.json())
        .then(data => {
            const settings = data.settings;
            settings.objective = projectObjective.value;
            settings.columns = columnSettings;

            // Save the updated settings
            fetch(`/save_project_settings/{{ project }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Error saving settings');
                }
            });
        });
};

function loadSettings() {
            fetch(`/get_project_settings/{{ project }}`)
                .then(response => response.json())
                .then(data => {
                    const settings = data.settings;
                    const columns = data.columns;
                    availableModels = data.available_models;
                    
                    projectObjective.value = settings.objective || '';
                    
                    // Load model options
                    const modelSelect = document.getElementById('newAnnotatorModel');
                    modelSelect.innerHTML = '<option value="">Select Model</option>' +
                        availableModels.map(model => `<option value="${model}">${model}</option>`).join('');
                    
                    // Load columns
                    columnsContainer.innerHTML = '';
                    columns.forEach(column => {
                        const columnSettings = settings.columns[column] || {
                            show: true,
                            label: false,
                            content: false,
                            filter: false
                        };
                        columnsContainer.appendChild(createColumnElement(column, columnSettings));
                    });

                    // Load AI models
                    annotatorsList.innerHTML = '';
                    judgesList.innerHTML = '';
                    const models = settings.ai_annotators || [];
                    models.forEach(model => {
                        if (model.roles?.includes('annotator')) {
                            annotatorsList.appendChild(createModelElement(model));
                        }
                        if (model.roles?.includes('judge')) {
                            judgesList.appendChild(createModelElement(model));
                        }
                    });

                    // Set last model settings if any models exist
                    if (models.length > 0) {
                        lastModelSettings = models[models.length - 1];
                        // Prepopulate form with last model settings
                        document.getElementById('newAnnotatorModel').value = lastModelSettings.model_name;
                        document.getElementById('newAnnotatorTemp').value = lastModelSettings.temperature;
                        document.getElementById('newAnnotatorPrompt').value = lastModelSettings.prompt;
                    }

                    // Update label configs based on active label columns
                    updateLabelConfigs();
                });
        }

        // Load initial settings
        loadSettings();
    });
</script>
</body>
</html>
