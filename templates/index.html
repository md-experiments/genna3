<!-- Previous code remains unchanged until loadAnnotations function -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genna</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body data-project="{{ project }}">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Genna</a>
            <div class="d-flex">
                <a href="/settings/{{ project }}" class="btn btn-outline-secondary me-2">Settings</a>
                <div class="form-check form-switch ms-2">
                    <input class="form-check-input mode-switch" type="checkbox" id="modeSwitch">
                    <label class="form-check-label" for="modeSwitch">Dark</label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>{{ project }}</h2>
                <p class="text-muted">{{ objective }}</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select" id="fileSelect" style="width: auto;">
                        <option value="">Select a file...</option>
                    </select>
                    <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
                        <i class="bi bi-upload"></i> Upload CSV
                    </button>
                    <input type="file" id="fileUpload" accept=".csv" style="display: none;" onchange="uploadFile(this)">
                    <button class="btn btn-danger" onclick="deleteFile()" id="deleteBtn" style="display: none;">
                        <i class="bi bi-trash"></i> Delete File
                    </button>
                </div>
            </div>
        </div>

<div id="dataContainer" style="display: none;">
    <div class="table-responsive">
        <table class="table">
            <thead id="tableHeader">
                <tr>
                    <th style="width: 40px;"></th>
                    <!-- Column headers will be added here -->
                </tr>
                <tr class="filter-row">
                    <th></th>
                    <!-- Filter inputs will be added here -->
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data rows will be added here -->
            </tbody>
        </table>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load file list
        function loadFiles() {
            const project = document.body.getAttribute('data-project');
            fetch(`/get_project_files/${project}`)
                .then(response => response.json())
                .then(files => {
                    const fileSelect = document.getElementById('fileSelect');
                    fileSelect.innerHTML = '<option value="">Select a file...</option>' +
                        files.map(file => `<option value="${file}">${file}</option>`).join('');
                });
        }

        // File selection handler
        document.getElementById('fileSelect').addEventListener('change', function() {
            const filename = this.value;
            document.getElementById('deleteBtn').style.display = filename ? 'block' : 'none';
            if (filename) {
                loadFileData(filename);
            } else {
                document.getElementById('dataContainer').style.display = 'none';
            }
        });
        
        // Load file data
function loadFileData(filename) {
    const project = document.body.getAttribute('data-project');
    fetch(`/load_csv/${project}/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Create header and filter rows
            const headerRow = document.createElement('tr');
            const filterRow = document.createElement('tr');
            filterRow.className = 'filter-row';
            
            headerRow.innerHTML = `
                <th style="width: 40px;"></th>
                <th style="width: 150px;">Model</th>
                ${data.columns.map(col => `<th>${col}</th>`).join('')}
            `;
            
            filterRow.innerHTML = `
                <th></th>
                <th></th>
                ${data.columns.map(col => `
                    <th>
                        <input type="text" class="form-control form-control-sm column-filter" 
                               data-column="${col}" placeholder="Filter ${col}...">
                    </th>
                `).join('')}
            `;

            const thead = document.getElementById('tableHeader');
            thead.innerHTML = '';
            thead.appendChild(headerRow);
            thead.appendChild(filterRow);

            // Store the original data for filtering
            window.originalData = data.data;
            
            // Create data rows
            renderTableData(data);

            document.getElementById('dataContainer').style.display = 'block';
            loadAnnotations(filename);

            // Add filter event listeners
            document.querySelectorAll('.column-filter').forEach(input => {
                input.addEventListener('input', filterData);
            });
        });
}

function filterData() {
    const filters = {};
    document.querySelectorAll('.column-filter').forEach(input => {
        const value = input.value.trim().toLowerCase();
        if (value) {
            filters[input.dataset.column] = value;
        }
    });

    const filteredData = window.originalData.filter(row => {
        return Object.entries(filters).every(([column, filterValue]) => {
            const cellValue = String(row[column] || '').toLowerCase();
            return cellValue.includes(filterValue);
        });
    });

    renderTableData({ 
        data: filteredData, 
        columns: window.originalData.length > 0 ? Object.keys(window.originalData[0]) : [],
        column_settings: window.lastColumnSettings,
        ai_annotators: window.lastAnnotators
    });
}

function renderTableData(data) {
    // Store settings for reuse
    window.lastColumnSettings = data.column_settings;
    window.lastAnnotators = data.ai_annotators;

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = data.data.map((row, index) => `
        <tr data-row-id="${index}">
            <td style="width: 40px;">
                <button class="expand-row" onclick="toggleAnnotations('${index}')">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </td>
            <td style="width: 150px;"></td>
            ${data.columns.map(col => `
                <td>
                    ${row[col] || ''}
                </td>
            `).join('')}
        </tr>
        <tr class="annotations-row" style="display: none;" data-row-id="${index}">
            <td colspan="${data.columns.length + 2}">
                <div class="row-annotations">
                    <table class="table">
                        <tbody>
                            ${data.ai_annotators.map(model => `
                                <tr class="model-row" data-model="${model.annotator_id}" style="display: none;">
                                    <td style="width: 40px;"></td>
                                    <td style="width: 150px;">
                                        <span class="model-indicator" title="${model.name}">
                                            <i class="bi bi-robot"></i>
                                            <span class="model-name">${model.name}</span>
                                        </span>
                                    </td>
                                    ${data.columns.map(col => `
                                        <td>
                                            ${data.column_settings?.[col]?.label ? `
                                                <div class="annotation-cell">
                                                    <span class="annotation-value" data-model="${model.annotator_id}" data-column="${col}">
                                                        Not annotated
                                                    </span>
                                                    <div class="label-actions">
                                                        <button class="label-btn thumbs-up" onclick="setLabel('${index}', '${col}', true, '${model.annotator_id}')" title="Correct">
                                                            <i class="bi bi-hand-thumbs-up"></i>
                                                        </button>
                                                        <button class="label-btn thumbs-down" onclick="setLabel('${index}', '${col}', false, '${model.annotator_id}')" title="Incorrect">
                                                            <i class="bi bi-hand-thumbs-down"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
    `).join('');

    // Add column header for model name
    const headerRow = document.querySelector('#tableHeader tr:first-child');
    if (headerRow) {
        const modelNameHeader = document.createElement('th');
        modelNameHeader.style.width = '150px';
        headerRow.insertBefore(modelNameHeader, headerRow.children[1]);
    }

    // Add filter input for model name
    const filterRow = document.querySelector('#tableHeader tr.filter-row');
    if (filterRow) {
        const modelNameFilter = document.createElement('th');
        modelNameFilter.style.width = '150px';
        filterRow.insertBefore(modelNameFilter, filterRow.children[1]);
    }
}

function loadAnnotations(filename) {
    const project = document.body.getAttribute('data-project');
    fetch(`/load_annotations/${project}/${filename}`)
        .then(response => response.json())
        .then(data => {
            // Handle AI annotations first
            if (data.ai_annotations) {
                Object.entries(data.ai_annotations).forEach(([modelId, modelAnnotations]) => {
                    Object.entries(modelAnnotations).forEach(([rowId, rowAnnotations]) => {
                        // Only show model row if it has annotations for this row
                        if (Object.keys(rowAnnotations).length > 0) {
                            const modelRow = document.querySelector(
                                `tr.annotations-row[data-row-id="${rowId}"] .model-row[data-model="${modelId}"]`
                            );
                            if (modelRow) {
                                modelRow.style.display = 'table-row';
                                
                                Object.entries(rowAnnotations).forEach(([column, value]) => {
                                    const headerCells = document.querySelector('#tableHeader tr:first-child').cells;
                                    const columnIndex = Array.from(headerCells).findIndex(cell => cell.textContent.trim() === column);
                                    if (columnIndex !== -1) {
                                        // Add 2 to account for expand button and model name columns
                                        const cell = modelRow.cells[columnIndex];
                                        if (cell) {
                                            const valueSpan = cell.querySelector('.annotation-value');
                                            if (valueSpan) {
                                                valueSpan.textContent = value;
                                                valueSpan.style.display = 'inline-block';
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    });
                });
            }

            // Handle manual annotations
            if (data.manual_annotations) {
                Object.entries(data.manual_annotations).forEach(([rowId, annotations]) => {
                    Object.entries(annotations).forEach(([column, value]) => {
                        if (value.model_id) {
                            const modelRow = document.querySelector(
                                `tr.annotations-row[data-row-id="${rowId}"] .model-row[data-model="${value.model_id}"]`
                            );
                            if (modelRow) {
                                const headerCells = document.querySelector('#tableHeader tr:first-child').cells;
                                const columnIndex = Array.from(headerCells).findIndex(cell => cell.textContent.trim() === column);
                                if (columnIndex !== -1) {
                                    // Add 2 to account for expand button and model name columns
                                    const cell = modelRow.cells[columnIndex];
                                    if (cell) {
                                        const btn = cell.querySelector(value ? '.thumbs-up' : '.thumbs-down');
                                        if (btn) btn.classList.add('active');
                                    }
                                }
                            }
                        }
                    });
                });
            }
        });
}

// Upload file
function uploadFile(input) {
            if (!input.files.length) return;

            const file = input.files[0];
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('project', document.body.getAttribute('data-project'));

            fetch('/upload_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    loadFiles();
                    input.value = '';
                }
            });
        }

        // Delete file
        function deleteFile() {
            const filename = document.getElementById('fileSelect').value;
            if (!filename) return;

            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

            fetch('/delete_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project: document.body.getAttribute('data-project'),
                    filename: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('fileSelect').value = '';
                    document.getElementById('deleteBtn').style.display = 'none';
                    document.getElementById('dataContainer').style.display = 'none';
                    loadFiles();
                } else {
                    alert(data.message);
                }
            });
        }

        // Toggle annotations
        function toggleAnnotations(rowId) {
            const button = document.querySelector(`tr[data-row-id="${rowId}"] .expand-row i`);
            const annotationsRow = document.querySelector(`tr.annotations-row[data-row-id="${rowId}"]`);
            
            if (annotationsRow.style.display === 'none') {
                button.classList.remove('bi-chevron-right');
                button.classList.add('bi-chevron-down');
                annotationsRow.style.display = 'table-row';
            } else {
                button.classList.remove('bi-chevron-down');
                button.classList.add('bi-chevron-right');
                annotationsRow.style.display = 'none';
            }
        }

// Set label
function setLabel(rowId, column, value, modelId) {
    const project = document.body.getAttribute('data-project');
    const filename = document.getElementById('fileSelect').value;
    if (!filename) return;

    const row = document.querySelector(`tr.annotations-row[data-row-id="${rowId}"] .model-row[data-model="${modelId}"]`);
    if (!row) return;

    // Find the cell by column index, accounting for expand and model name columns
    const headerCells = document.querySelector('#tableHeader tr:first-child').cells;
    const columnIndex = Array.from(headerCells).findIndex(cell => cell.textContent.trim() === column);
    if (columnIndex === -1) return;

    // Add 2 to account for expand button and model name columns
    const cell = row.cells[columnIndex];
    if (!cell) return;

    const thumbsUp = cell.querySelector('.thumbs-up');
    const thumbsDown = cell.querySelector('.thumbs-down');
    
    if (thumbsUp && thumbsDown) {
        thumbsUp.classList.toggle('active', value);
        thumbsDown.classList.toggle('active', !value);

        fetch(`/save_annotations/${project}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project: project,
                csv_filename: filename,
                manual_annotations: {
                    [rowId]: {
                        [column]: value,
                        model_id: modelId
                    }
                }
            })
        });
    }
}

// Initialize dark mode
const modeSwitch = document.getElementById('modeSwitch');
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            modeSwitch.checked = true;
        }

        modeSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', modeSwitch.checked);
        });

        // Initial load
        loadFiles();
    </script>
</body>
</html>
