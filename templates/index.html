<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genna</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body data-project="{{ project }}">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Genna</a>
            <div class="d-flex">
                <a href="/settings/{{ project }}" class="btn btn-outline-secondary me-2">Settings</a>
                <div class="form-check form-switch ms-2">
                    <input class="form-check-input mode-switch" type="checkbox" id="modeSwitch">
                    <label class="form-check-label" for="modeSwitch">Dark</label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>{{ project }}</h2>
                <p class="text-muted">{{ objective }}</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select" id="fileSelect" style="width: auto;">
                        <option value="">Select a file...</option>
                    </select>
                    <button class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
                        <i class="bi bi-upload"></i> Upload CSV
                    </button>
                    <input type="file" id="fileUpload" accept=".csv" style="display: none;" onchange="uploadFile(this)">
                    <button class="btn btn-danger" onclick="deleteFile()" id="deleteBtn" style="display: none;">
                        <i class="bi bi-trash"></i> Delete File
                    </button>
                </div>
            </div>
        </div>

        <div id="dataContainer" style="display: none;">
            <div class="table-responsive">
                <table class="table">
                    <thead id="tableHeader">
                        <!-- Column headers will be added here -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load file list
        function loadFiles() {
            const project = document.body.getAttribute('data-project');
            fetch(`/get_project_files/${project}`)
                .then(response => response.json())
                .then(files => {
                    const fileSelect = document.getElementById('fileSelect');
                    fileSelect.innerHTML = '<option value="">Select a file...</option>' +
                        files.map(file => `<option value="${file}">${file}</option>`).join('');
                });
        }

        // File selection handler
        document.getElementById('fileSelect').addEventListener('change', function() {
            const filename = this.value;
            document.getElementById('deleteBtn').style.display = filename ? 'block' : 'none';
            if (filename) {
                loadFileData(filename);
            } else {
                document.getElementById('dataContainer').style.display = 'none';
            }
        });

        // Load file data
        function loadFileData(filename) {
            const project = document.body.getAttribute('data-project');
            fetch(`/load_csv/${project}/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Create header row
                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `
                        <th style="width: 40px;"></th>
                        ${data.columns.map(col => `<th>${col}</th>`).join('')}
                    `;
                    document.getElementById('tableHeader').innerHTML = '';
                    document.getElementById('tableHeader').appendChild(headerRow);

                    // Create data rows
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = data.data.map((row, index) => `
                        <tr data-row-id="${index}">
                            <td>
                                <button class="expand-row" onclick="toggleAnnotations('${index}')">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </td>
                            ${data.columns.map(col => `
                                <td>
                                    ${row[col] || ''}
                                    ${data.column_settings?.[col]?.label ? `
                                        <div class="label-actions">
                                            <button class="label-btn thumbs-up" onclick="setLabel('${index}', '${col}', true)" title="Correct">
                                                <i class="bi bi-hand-thumbs-up"></i>
                                            </button>
                                            <button class="label-btn thumbs-down" onclick="setLabel('${index}', '${col}', false)" title="Incorrect">
                                                <i class="bi bi-hand-thumbs-down"></i>
                                            </button>
                                        </div>
                                    ` : ''}
                                </td>
                            `).join('')}
                        </tr>
        <tr class="annotations-row" style="display: none;" data-row-id="${index}">
            <td colspan="${data.columns.length + 1}">
                <div class="row-annotations">
                    <table class="table">
                        <tbody>
                            ${data.ai_annotators.map(model => `
                                <tr class="model-row" data-model="${model.annotator_id}">
                                    <td style="width: 40px;">
                                        <span class="model-indicator">
                                            <i class="bi bi-robot"></i>
                                        </span>
                                    </td>
                                    ${data.columns.map(col => `
                                        <td>
                                            ${data.column_settings?.[col]?.label ? `
                                                <span class="annotation-value" data-model="${model.annotator_id}" data-column="${col}">
                                                    Not annotated
                                                </span>
                                            ` : ''}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
`).join('');

                    document.getElementById('dataContainer').style.display = 'block';
                    loadAnnotations(filename);
                });
        }

        // Upload file
        function uploadFile(input) {
            if (!input.files.length) return;

            const file = input.files[0];
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('project', document.body.getAttribute('data-project'));

            fetch('/upload_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    loadFiles();
                    input.value = '';
                }
            });
        }

        // Delete file
        function deleteFile() {
            const filename = document.getElementById('fileSelect').value;
            if (!filename) return;

            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

            fetch('/delete_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    project: document.body.getAttribute('data-project'),
                    filename: filename
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('fileSelect').value = '';
                    document.getElementById('deleteBtn').style.display = 'none';
                    document.getElementById('dataContainer').style.display = 'none';
                    loadFiles();
                } else {
                    alert(data.message);
                }
            });
        }

        // Toggle annotations
        function toggleAnnotations(rowId) {
            const button = document.querySelector(`tr[data-row-id="${rowId}"] .expand-row i`);
            const annotationsRow = document.querySelector(`tr.annotations-row[data-row-id="${rowId}"]`);
            
            if (annotationsRow.style.display === 'none') {
                button.classList.remove('bi-chevron-right');
                button.classList.add('bi-chevron-down');
                annotationsRow.style.display = 'table-row';
            } else {
                button.classList.remove('bi-chevron-down');
                button.classList.add('bi-chevron-right');
                annotationsRow.style.display = 'none';
            }
        }

        // Load annotations
        function loadAnnotations(filename) {
            const project = document.body.getAttribute('data-project');
            fetch(`/load_annotations/${project}/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.manual_annotations) {
                        Object.entries(data.manual_annotations).forEach(([rowId, annotations]) => {
                            Object.entries(annotations).forEach(([column, value]) => {
                                const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
                                if (row) {
                                    const cells = Array.from(row.cells);
                                    const cell = cells.find(cell => cell.textContent.trim().startsWith(column));
                                    if (cell) {
                                        const btn = cell.querySelector(value ? '.thumbs-up' : '.thumbs-down');
                                        if (btn) btn.classList.add('active');
                                    }
                                }
                            });
                        });
                    }

                    if (data.ai_annotations) {
                        Object.entries(data.ai_annotations).forEach(([modelId, modelAnnotations]) => {
                            Object.entries(modelAnnotations).forEach(([rowId, rowAnnotations]) => {
                                Object.entries(rowAnnotations).forEach(([column, value]) => {
                                    const element = document.querySelector(
                                        `tr.annotations-row[data-row-id="${rowId}"] ` +
                                        `.annotation-value[data-model="${modelId}"][data-column="${column}"]`
                                    );
                                    if (element) {
                                        element.textContent = value;
                                    }
                                });
                            });
                        });
                    }
                });
        }

        // Set label
        function setLabel(rowId, column, value) {
            const project = document.body.getAttribute('data-project');
            const filename = document.getElementById('fileSelect').value;
            if (!filename) return;

            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            const cells = Array.from(row.cells);
            const cell = cells.find(cell => cell.textContent.trim().startsWith(column));
            
            if (cell) {
                const thumbsUp = cell.querySelector('.thumbs-up');
                const thumbsDown = cell.querySelector('.thumbs-down');
                
                thumbsUp.classList.toggle('active', value);
                thumbsDown.classList.toggle('active', !value);

                fetch(`/save_annotations/${project}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project: project,
                        csv_filename: filename,
                        manual_annotations: {
                            [rowId]: {
                                [column]: value
                            }
                        }
                    })
                });
            }
        }

        // Initialize dark mode
        const modeSwitch = document.getElementById('modeSwitch');
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            modeSwitch.checked = true;
        }

        modeSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', modeSwitch.checked);
        });

        // Initial load
        loadFiles();
    </script>
</body>
</html>
